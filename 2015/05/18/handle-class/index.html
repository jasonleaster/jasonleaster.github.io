<!DOCTYPE html>
<html lang="zh">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Handle Class"/>







  <link rel="alternate" href="/atom.xml" title="EOF">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.2.x" />



<link rel="canonical" href="http://jasonleaster.github.io/2015/05/18/handle-class/"/>


<meta name="description" content="For some types of class, if we could avoid the copy operation, it will be great advantage.
Sometimes, copy cost a lot.
It’s not a good way to use pointer to avoid copy operation. It’s unsafe.
What if">
<meta property="og:type" content="article">
<meta property="og:title" content="Handle Class">
<meta property="og:url" content="http://jasonleaster.github.io/2015/05/18/handle-class/index.html">
<meta property="og:site_name" content="EOF">
<meta property="og:description" content="For some types of class, if we could avoid the copy operation, it will be great advantage.
Sometimes, copy cost a lot.
It’s not a good way to use pointer to avoid copy operation. It’s unsafe.
What if">
<meta property="og:image" content="http://jasonleaster.github.io/images/img_for_2015_05_19/arch.png">
<meta property="og:image" content="http://jasonleaster.github.io/images/img_for_2015_05_19/output.png">
<meta property="og:image" content="http://jasonleaster.github.io/images/img_for_2015_05_19/scenery.png">
<meta property="og:updated_time" content="2016-02-04T05:02:53.519Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Handle Class">
<meta name="twitter:description" content="For some types of class, if we could avoid the copy operation, it will be great advantage.
Sometimes, copy cost a lot.
It’s not a good way to use pointer to avoid copy operation. It’s unsafe.
What if">
<meta name="twitter:image" content="http://jasonleaster.github.io/images/img_for_2015_05_19/arch.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.2.x" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />





<script type="text/javascript">
  var themeConfig = {
    search: {
      enable: true,
      path: "/search.xml",
    },
    navbar: {
      enable: true
    },
    fancybox: {
      enable: true
    },
    toc: {
      enable: true
    },
  };
</script>



  



    <title> Handle Class · EOF </title>
  </head>

  <body>
    <div class="container">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">EOF</a>
</div>

<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
      
        <li class="menu-search">
          <form>
            <i class="iconfont icon-search" id="open-search"></i>
            <input type="text" class="search-input" id="search-input" />
            <i class="iconfont icon-close" id="close-search"></i>
          </form>
        </li>
      
    </ul>
  
</nav>

<div class="mobile-navbar">
  <div class="mobile-header">
    <div class="mobile-header-logo">
      <a href="/." class="logo">EOF</a>
    </div>

    <div class="mobile-header-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
  <nav class="mobile-menu">
    
      <a class="mobile-menu-item" href="/">
        
        
          Home
        
      </a>
    
      <a class="mobile-menu-item" href="/archives/">
        
        
          Archives
        
      </a>
    
  </nav>
</div>
      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Handle Class
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          May 18, 2015
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        <p>For some types of class, if we could avoid the copy operation, it will be great advantage.</p>
<p>Sometimes, copy cost a lot.</p>
<p>It’s not a good way to use pointer to avoid copy operation. It’s unsafe.</p>
<p>What if we want the attribute of polymiorphism and reduce the cost of copy ?</p>
<p>The answer is Handle which is a special class.</p>
<a id="more"></a>
<p>We use count to avoid copying. The count can not be a part of handle. If we do that, each handle have to know others handles’ location(it’s easy for us to get address of members who are in the same class). Only we do that, we could update the count correctly. We also could not let the count be a part of objects. Becasue we have to rewrite the type of class which have already existed.</p>
<p>So, we define a new type of class to store the count and object.</p>
<p><img src="/images/img_for_2015_05_19/arch.png" alt="images"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**********************************************</span></div><div class="line">    Programmer  :   EOF</div><div class="line">    Date        :   2015.05.19</div><div class="line">    File        :   6.6.cpp</div><div class="line">    E-mail      :   jasonleaster@gmail.com</div><div class="line"></div><div class="line">**********************************************/</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">class</span> Point</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        Point(): xval(<span class="number">0</span>), yval(<span class="number">0</span>) &#123; &#125;</div><div class="line">        Point(<span class="keyword">int</span> x, <span class="keyword">int</span> y): xval(x), yval(y) &#123; &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">x</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> xval; &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">y</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> yval; &#125;</div><div class="line">        <span class="function">Point&amp; <span class="title">x</span><span class="params">(<span class="keyword">int</span> xv)</span> </span>&#123; xval = xv; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</div><div class="line">        <span class="function">Point&amp; <span class="title">y</span><span class="params">(<span class="keyword">int</span> yv)</span> </span>&#123; yval = yv; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        <span class="keyword">int</span> xval, yval;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">   This class is used for store the @Point class and count @u</div><div class="line"> */</div><div class="line"><span class="keyword">class</span> UPoint</div><div class="line">&#123;</div><div class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> Handle;</div><div class="line">    Point p;</div><div class="line">    <span class="keyword">int</span> counter;</div><div class="line"></div><div class="line">    UPoint(): counter(<span class="number">1</span>) &#123; &#125;</div><div class="line">    UPoint(<span class="keyword">int</span> x, <span class="keyword">int</span> y): p(x, y), counter(<span class="number">1</span>)  &#123; &#125;</div><div class="line">    UPoint(<span class="keyword">const</span> Point&amp; p0): p(p0), counter(<span class="number">1</span>) &#123; &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">class</span> Handle</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        Handle();</div><div class="line">        Handle(<span class="keyword">int</span>, <span class="keyword">int</span>);</div><div class="line">        Handle(<span class="keyword">const</span> Point&amp;);</div><div class="line">        Handle(<span class="keyword">const</span> Handle&amp;);</div><div class="line"></div><div class="line">        Handle&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> Handle&amp;);</div><div class="line"></div><div class="line">        ~Handle();</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">x</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line">        <span class="function">Handle&amp; <span class="title">x</span><span class="params">(<span class="keyword">int</span>)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">y</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line">        <span class="function">Handle&amp; <span class="title">y</span><span class="params">(<span class="keyword">int</span>)</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        <span class="comment">/*</span></div><div class="line">            All we have done in @Handle is to maintain this data member :)</div><div class="line">         */</div><div class="line">        UPoint *up;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Handle::~Handle()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (--up-&gt;counter == <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">delete</span> up;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">   Constructor function of @Handle</div><div class="line"> */</div><div class="line">Handle::Handle(): up(<span class="keyword">new</span> UPoint) &#123; &#125;</div><div class="line">Handle::Handle(<span class="keyword">int</span> x, <span class="keyword">int</span> y): up(<span class="keyword">new</span> UPoint(x, y)) &#123; &#125;</div><div class="line">Handle::Handle(<span class="keyword">const</span> Point&amp; p): up(<span class="keyword">new</span> UPoint(p)) &#123; &#125;</div><div class="line">Handle::Handle(<span class="keyword">const</span> Handle&amp; h): up(h.up) &#123; ++up-&gt;counter; &#125;</div><div class="line"></div><div class="line">Handle&amp;</div><div class="line">Handle::<span class="keyword">operator</span> = (<span class="keyword">const</span> Handle&amp; h)</div><div class="line">&#123;</div><div class="line">    ++(h.up-&gt;counter);</div><div class="line">    <span class="keyword">if</span>(--(up-&gt;counter) == <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">delete</span> up;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    up = h.up;</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> Handle::x() <span class="keyword">const</span> &#123; <span class="keyword">return</span> up-&gt;p.x(); &#125;</div><div class="line"><span class="keyword">int</span> Handle::y() <span class="keyword">const</span> &#123; <span class="keyword">return</span> up-&gt;p.y(); &#125;</div><div class="line"></div><div class="line">Handle&amp; Handle::x(<span class="keyword">int</span> x0)</div><div class="line">&#123;</div><div class="line">    up-&gt;p.x(x0);</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Handle&amp; Handle::y(<span class="keyword">int</span> y0)</div><div class="line">&#123;</div><div class="line">    up-&gt;p.y(y0);</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function">Handle <span class="title">h</span><span class="params">(<span class="number">3</span>, <span class="number">4</span>)</span></span>;</div><div class="line">    Handle h2 = h;</div><div class="line"></div><div class="line">    h2.x(<span class="number">5</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> n = h.x();</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"n = "</span> &lt;&lt; n &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In this scheme, we meet a weak point of the mechanisim that we have to attach the handler onto the class (in our demo, it’s @UPoint).</p>
<p>It’s not convenient for us to use that scheme for different types of class which are inhiret from base class.</p>
<p>We sperate data and reference count by changing our handle into this:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> Handle</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="comment">// member unchanged</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        Point* p_Point;</div><div class="line">        UseCount u;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Here is the other and better implementation for handle.</p>
<p>In this implementation, we use a very cool teachnology – Copy On Write(COW). You may have see this teachnology in Operating System which use it to implement a very important function – <code>fork</code> .</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**********************************************</span></div><div class="line">    Programmer  :   EOF</div><div class="line">    Date        :   2015.05.19</div><div class="line">    File        :   7.3.cpp</div><div class="line">    E-mail      :   jasonleaster@gmail.com</div><div class="line"></div><div class="line">**********************************************/</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> COW</span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">class</span> Point</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        Point(): xval(<span class="number">0</span>), yval(<span class="number">0</span>) &#123; &#125;</div><div class="line">        Point(<span class="keyword">int</span> x, <span class="keyword">int</span> y): xval(x), yval(y) &#123; &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">x</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> xval; &#125;</div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">y</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> yval; &#125;</div><div class="line">        <span class="function">Point&amp; <span class="title">x</span><span class="params">(<span class="keyword">int</span> xv)</span> </span>&#123; xval = xv; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</div><div class="line">        <span class="function">Point&amp; <span class="title">y</span><span class="params">(<span class="keyword">int</span> yv)</span> </span>&#123; yval = yv; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        <span class="keyword">int</span> xval, yval;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">class</span> UseCount</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        UseCount();</div><div class="line">        UseCount(<span class="keyword">const</span> UseCount&amp;);</div><div class="line">        ~UseCount();</div><div class="line">        <span class="comment">//another things</span></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">only</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">reattach</span><span class="params">(<span class="keyword">const</span> UseCount&amp; )</span></span>;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">makeonly</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        <span class="keyword">int</span>* p_counter;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">UseCount::UseCount(): p_counter(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">1</span>)) &#123; &#125;</div><div class="line"></div><div class="line">UseCount::UseCount(<span class="keyword">const</span> UseCount&amp; u): p_counter(u.p_counter)</div><div class="line">&#123;</div><div class="line">    ++(*p_counter);</div><div class="line">&#125;</div><div class="line"></div><div class="line">UseCount::~UseCount()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (--(*p_counter) == <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">delete</span> p_counter;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> UseCount::only() &#123; <span class="keyword">return</span> *p_counter == <span class="number">1</span>; &#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> UseCount::reattach(<span class="keyword">const</span> UseCount&amp; u)</div><div class="line">&#123;</div><div class="line">    ++(*u.p_counter);</div><div class="line">    <span class="keyword">if</span>(--*p_counter == <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">delete</span> p_counter;</div><div class="line">        p_counter = u.p_counter;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    p_counter = u.p_counter;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> UseCount::makeonly()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(*p_counter == <span class="number">1</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    --(*p_counter);</div><div class="line">    p_counter = <span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">class</span> Handle</div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        Handle();</div><div class="line">        Handle(<span class="keyword">int</span>, <span class="keyword">int</span>);</div><div class="line">        Handle(<span class="keyword">const</span> Point&amp;);</div><div class="line">        Handle(<span class="keyword">const</span> Handle&amp;);</div><div class="line"></div><div class="line">        Handle&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> Handle&amp;);</div><div class="line"></div><div class="line">        ~Handle();</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">x</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line">        <span class="function">Handle&amp; <span class="title">x</span><span class="params">(<span class="keyword">int</span>)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">y</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line">        <span class="function">Handle&amp; <span class="title">y</span><span class="params">(<span class="keyword">int</span>)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">show_pointer</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="built_in">cout</span> &lt;&lt; p_Point &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        <span class="comment">// what we added</span></div><div class="line">        Point *p_Point;</div><div class="line">        UseCount u;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Handle::~Handle()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (u.only())</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">delete</span> p_Point;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">   Constructor function of @Handle</div><div class="line"> */</div><div class="line">Handle::Handle(): p_Point(<span class="keyword">new</span> Point) &#123; &#125;</div><div class="line">Handle::Handle(<span class="keyword">int</span> x, <span class="keyword">int</span> y): p_Point(<span class="keyword">new</span> Point(x, y)) &#123; &#125;</div><div class="line">Handle::Handle(<span class="keyword">const</span> Point&amp; p0): p_Point(<span class="keyword">new</span> Point(p0)) &#123; &#125;</div><div class="line">Handle::Handle(<span class="keyword">const</span> Handle&amp; h): u(h.u), p_Point(h.p_Point) &#123; &#125;</div><div class="line"></div><div class="line">Handle&amp;</div><div class="line">Handle::<span class="keyword">operator</span> = (<span class="keyword">const</span> Handle&amp; h)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(u.reattach(h.u))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">delete</span> p_Point;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    p_Point = h.p_Point;</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> COW</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> Handle::x() <span class="keyword">const</span> &#123; <span class="keyword">return</span> p_Point-&gt;x(); &#125;</div><div class="line"><span class="keyword">int</span> Handle::y() <span class="keyword">const</span> &#123; <span class="keyword">return</span> p_Point-&gt;y(); &#125;</div><div class="line"></div><div class="line">Handle&amp; Handle::x(<span class="keyword">int</span> x0)</div><div class="line">&#123;</div><div class="line">    p_Point-&gt;x(x0);</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Handle&amp; Handle::y(<span class="keyword">int</span> y0)</div><div class="line">&#123;</div><div class="line">    p_Point-&gt;y(y0);</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="comment">/*</span></div><div class="line">   "Copy On Write"</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">int</span> Handle::x() <span class="keyword">const</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> p_Point-&gt;x();</div><div class="line">&#125;</div><div class="line"></div><div class="line">Handle&amp; Handle::x(<span class="keyword">int</span> x0)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(u.makeonly())</div><div class="line">    &#123;</div><div class="line">        p_Point = <span class="keyword">new</span> Point(*p_Point);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    p_Point-&gt;x(x0);</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function">Handle <span class="title">h</span><span class="params">(<span class="number">3</span>, <span class="number">4</span>)</span></span>;</div><div class="line">    Handle h2 = h;</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"before rewriting"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    h.show_pointer();</div><div class="line">    h2.show_pointer();</div><div class="line"></div><div class="line">    h2.x(<span class="number">5</span>);</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"after rewriting"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    h.show_pointer();</div><div class="line">    h2.show_pointer();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> n = h.x();</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"n = "</span> &lt;&lt; n &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You will get this output :)</p>
<p><img src="/images/img_for_2015_05_19/output.png" alt="images"></p>
<hr>
<p>Photo by Jason Leaster in XiangTan University</p>
<p><img src="/images/img_for_2015_05_19/scenery.png" alt="images"></p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>作者: </span>
      <span>Jason Leaster</span>
    </p>
    <p class="copyright-item">
      <span>来源: </span>
      <a href="http://jasonleaster.github.io">http://jasonleaster.github.io</a>
    </p>
    <p class="copyright-item">
      <span>链接: </span>
      <a href="http://jasonleaster.github.io/2015/05/18/handle-class/">http://jasonleaster.github.io/2015/05/18/handle-class/</a>
    </p>

    <p class="copyright-item lincese">
      
      本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
    </p>
  </div>



      
      
    

    
  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>

        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:jasonleaster@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/jasonleaster" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
        
          <a href="https://zhihu.com/jasonleaster" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Jason Leaster</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

    <script type="text/javascript" src="/js/src/even.js?v=2.2.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.2.x"></script>

  </body>
</html>