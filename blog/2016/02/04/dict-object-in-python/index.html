
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dict Object in Python - EOF</title>
  <meta name="author" content="Jason Leaster">

  
  <meta name="description" content="Try to answer these question. Whatare dictionaries and sets good for? How are dictionaries and set the same? What is the overhead when using a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jasonleaster.github.io/blog/2016/02/04/dict-object-in-python/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="EOF" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">EOF</a></h1>
  
    <h2>Rebuilding The Tower Of Babel</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="jasonleaster.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/todo">TODO</a></li>
  <li><a href="/recommendation">Recommendation</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Dict Object in Python</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-02-04T12:54:11+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:54 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Try to answer these question.</p>

<ol>
  <li>
    <p>Whatare dictionaries and sets good for?</p>
  </li>
  <li>
    <p>How are dictionaries and set the same?</p>
  </li>
  <li>
    <p>What is the overhead when using a dictionary?</p>
  </li>
  <li>
    <p>How can I optimize the performance of a dictionary?</p>
  </li>
  <li>
    <p>How does Python use dictionaries to keep track of namespace?</p>
  </li>
</ol>

<!-- more -->

<p>Dictionary object type – mapping from hashable object to object</p>

<p>In the implemenation, Python don’t choose <code>Red-Black Tree</code> as the basic data structure but Hash Table with a special technology – <code>Open Addressing</code>.</p>

<p>About open addressing:</p>

<blockquote>
  <p>In computer science, lazy deletion refers to a method of deleting elements from a hash table that uses open addressing. In this method, deletions are done by marking an element as deleted, rather than erasing it entirely. Deleted locations are treated as empty when inserting and as occupied during a search. – Wikipedia</p>
</blockquote>

<p>There three kinds of slots in the table:</p>

<ol>
  <li>
    <p>Unused.  <code>me_key</code> == <code>me_value</code> == <code>NULL</code>
Does not hold an active (key, value) pair now and never did.  Unused can transition to Active upon key insertion.  This is the only case in which <code>me_key</code> is NULL, and is each slot’s initial state.</p>
  </li>
  <li>
    <p>Active.  <code>me_key</code> != NULL and <code>me_key</code> != dummy and <code>me_value</code> != NULL Holds an active (key, value) pair.  Active can transition to Dummy upon key deletion.  This is the only case in which <code>me_value</code> != NULL.</p>
  </li>
  <li>
    <p>Dummy.  <code>me_key</code> == dummy and <code>me_value</code> == NULL
Previously held an active (key, value) pair, but that was deleted and an active pair has not yet overwritten the slot.  Dummy can transition to Active upon key insertion. Dummy slots cannot be made Unused again (cannot have <code>me_key</code> set to NULL), else the probe sequence in case of collision would have no way to know they were once active.</p>
  </li>
</ol>

<p>Here, Python define the entry data type of dict in python <code>PyDictObejct</code>. A entry is like a paire (key, value). To avoid calculating the hash value of <code>me_key</code>, <code>me_hash</code> used as a cached value for it.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="p">[</span><span class="n">Include</span><span class="o">/</span><span class="n">dictobject</span><span class="p">.</span><span class="n">h</span><span class="p">]</span>
</span><span class="line"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="n">Py_ssize_t</span> <span class="n">me_hash</span><span class="p">;</span>
</span><span class="line">    <span class="n">PyObject</span> <span class="o">*</span><span class="n">me_key</span><span class="p">;</span>
</span><span class="line">    <span class="n">PyObject</span> <span class="o">*</span><span class="n">me_value</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span> <span class="n">PyDictEntry</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To ensure the lookup algorithm terminates, there must be at least one Unused slot (NULL key) in the table.</p>

<p>The value <code>ma_fill</code> is the number of non-NULL keys (sum of Active and Dummy);
   <code>ma_used</code> is the number of non-NULL, non-dummy keys (== the number of non-NULL values == the number of Active items).
   To avoid slowing down lookups on a near-full table, we resize the table when it’s <font color="red">two-thirds</font> full.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="p">[</span><span class="n">Include</span><span class="o">/</span><span class="n">dictobject</span><span class="p">.</span><span class="n">h</span><span class="p">]</span>
</span><span class="line"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_dictobject</span> <span class="n">PyDictObject</span><span class="p">;</span>
</span><span class="line"><span class="k">struct</span> <span class="n">_dictobject</span> <span class="p">{</span>
</span><span class="line">    <span class="n">PyObject_HEAD</span>
</span><span class="line">    <span class="n">Py_ssize_t</span> <span class="n">ma_fill</span><span class="p">;</span>  <span class="cm">/* # Active + # Dummy */</span>
</span><span class="line">    <span class="n">Py_ssize_t</span> <span class="n">ma_used</span><span class="p">;</span>  <span class="cm">/* # Active */</span>
</span><span class="line">    <span class="cm">/* The table contains ma_mask + 1 slots, and that&#39;s a power of 2.</span>
</span><span class="line"><span class="cm">     * We store the mask instead of the size because the mask is more</span>
</span><span class="line"><span class="cm">     * frequently needed.</span>
</span><span class="line"><span class="cm">     */</span>
</span><span class="line">    <span class="n">Py_ssize_t</span> <span class="n">ma_mask</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">     <span class="err">*/</span>
</span><span class="line">    <span class="n">PyDictEntry</span> <span class="o">*</span><span class="n">ma_table</span><span class="p">;</span>
</span><span class="line">    <span class="n">PyDictEntry</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">ma_lookup</span><span class="p">)(</span><span class="n">PyDictObject</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">long</span> <span class="n">hash</span><span class="p">);</span>
</span><span class="line">    <span class="n">PyDictEntry</span> <span class="n">ma_smalltable</span><span class="p">[</span><span class="n">PyDict_MINSIZE</span><span class="p">];</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>PyDict_MINSIZE</code> is the minimum size of a dictionary.  This many slots are allocated directly in the dict object.
(in the <code>ma_smalltable</code> member). 
It must be a power of 2, and at least 4.  8 allows dicts with no more than 5 active entries to live in <code>ma_smalltable</code> (and so avoid an additional malloc); instrumentation suggested this suffices for the majority of dicts (consisting mostly of usually-small instance dicts and usually-small dicts created to pass keyword arguments).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="cp">#define PyDict_MINSIZE 8</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here defined a array <code>ma_smalltable</code> which store 8 <code>PyDictEntry</code>.
<code>ma_table</code> points to <code>ma_smalltable</code> for small tables, else to 
additional malloc’ed memory.  <code>ma_table</code> is never NULL!<br />
This rule saves repeated runtime null-tests in the workhorse getitem and setitem calls.</p>

<p>I draw a figure to make the idea easy to be understand.</p>

<p><img src="/images/img_for_2016_02_04/dictTable.png" alt="images" /></p>

<p>The question is coming. When Python will resize the diction table of that object?</p>

<p>The answer is in function <code>dictresize</code> in file <code>Object/dictobject.c</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="p">[</span><span class="n">Object</span><span class="o">/</span><span class="n">dictobject</span><span class="p">.</span><span class="n">c</span><span class="p">]</span>
</span><span class="line"><span class="p">...</span>
</span><span class="line">
</span><span class="line"><span class="c1">// Recall the rule of 2/3 --notes by Jason Leaster</span>
</span><span class="line"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">ma_used</span> <span class="o">&gt;</span> <span class="n">n_used</span> <span class="o">&amp;&amp;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">ma_fill</span><span class="o">*</span><span class="mi">3</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">ma_mask</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
</span><span class="line">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Debug information add by Jason Leaster</span>
</span><span class="line">    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Try to resize the old diction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class="line">    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;mp-&gt;ma_used  :%p </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">ma_used</span><span class="p">);</span>
</span><span class="line">    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;mp-&gt;ma_fill  :%p </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">ma_fill</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="nf">dictresize</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">ma_used</span> <span class="o">&gt;</span> <span class="mi">50000</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">ma_used</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Attention, once <code>mp-ma_fill</code> bigger or equal to (2/3)<code>mp-&gt;ma_mask+1</code> and we have finished a insert operation(<code>mp-&gt;ma_used</code> &gt; <code>n_used</code>), <strong>we should resize the container(ma_table) of  the dictionary</strong>.</p>

<p>Yes, we should resize the dictionary object if there have 6 or more object in the container but <strong>not</strong> 8.</p>

<p>Here is the result of hacking.</p>

<p><img src="/images/img_for_2016_02_04/testResizeDict.png" alt="images" /></p>

<p>Actually, <code>dummy</code> PyDictObject is just a <code>PyStringObject</code> in Python. Initially, dummy is a pointer in C but it finally comes to a <code>PyStringObject</code> after initialization of <code>PyDictObject</code> first time.</p>

<p><strong>It’s important to note that resizing can happen to make a hash table larger or smaller. This is , if sufficiently many element of a hash table are deleted, the table can be scaled down in size. However, resizing only happens during an insert.</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="cm">/* Object used as dummy key to fill deleted entries */</span>
</span><span class="line"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">dummy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Initialized by first call to newPyDictObject() */</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="initialization-part">Initialization Part</h3>

<p>There are two ways to create a dict:  <code>PyDict_New()</code> is the main C API function, 
and the <code>tp_new</code> slot maps to <code>dict_new()</code>.  In the latter case we
    can save a little time over what PyDict_New does because it’s guaranteed
    that the PyDictObject struct is already zeroed out.
    Everyone except dict_new() should use EMPTY_TO_MINSIZE (unless they have an excellent reason not to).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="cp">#define INIT_NONZERO_DICT_SLOTS(mp) do { \</span>
</span><span class="line"><span class="cp">    (mp)-&gt;ma_table = (mp)-&gt;ma_smalltable;\</span>
</span><span class="line"><span class="cp">    (mp)-&gt;ma_mask = PyDict_MINSIZE - 1; \</span>
</span><span class="line"><span class="cp">} while(0)</span>
</span><span class="line">
</span><span class="line"><span class="cp">#define EMPTY_TO_MINSIZE(mp) do {   \</span>
</span><span class="line"><span class="cp">    memset((mp)-&gt;ma_smalltable, 0, sizeof((mp)-&gt;ma_smalltable))\</span>
</span><span class="line"><span class="cp">    (mp)-&gt;ma_used = (mp)-&gt;ma_fill = 0;\</span>
</span><span class="line"><span class="cp">    INIT_NONZERO_DICT_SLOTS(mp); \</span>
</span><span class="line"><span class="cp">        } while(0)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<hr />
<p>Photo By Jason Leaster</p>

<p><img src="/images/img_for_2016_02_04/street.jpg" alt="images" /></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jason Leaster</span></span>

      




<time class='entry-date' datetime='2016-02-04T12:54:11+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:54 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/c/'>c</a>, <a class='category' href='/blog/categories/python/'>python</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/02/03/memory-model-of-int-object-in-python/" title="Previous Post: Int Object in Python">&laquo; Int Object in Python</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/02/05/functional-programming-in-python/" title="Next Post: Functional Programming in Python">Functional Programming in Python &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/11/the-brief-introduction-to-the-archtecture-of-junit4/">The Brief Introduction to the Architecture of JUnit4</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/09/04/problems-with-linked-list/">Problems With Linked List</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/24/search-algorithm-in-graph/">Search Algorithm in Graph</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/14/great-ideas-in-object-oriented-programming/">Great Ideas in Object Oriented Programming</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/19/training-cascade-with-opencv/">Training Cascade With OpenCV</a>
      </li>
    
  </ul>
</section>


<section> 
  <h1>Categories</h1> 
  <ul id="categories"> 
    <li class='category'><a href='/blog/categories/algorithm/'>algorithm (4)</a></li>
<li class='category'><a href='/blog/categories/c/'>c (2)</a></li>
<li class='category'><a href='/blog/categories/cplusplus/'>cplusplus (7)</a></li>
<li class='category'><a href='/blog/categories/essay/'>essay (2)</a></li>
<li class='category'><a href='/blog/categories/java/'>java (2)</a></li>
<li class='category'><a href='/blog/categories/labs/'>labs (1)</a></li>
<li class='category'><a href='/blog/categories/machinelearning/'>machinelearning (4)</a></li>
<li class='category'><a href='/blog/categories/opencv/'>opencv (1)</a></li>
<li class='category'><a href='/blog/categories/python/'>python (9)</a></li>
 
  </ul> 
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Jason Leaster -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
