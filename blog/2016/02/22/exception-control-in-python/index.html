
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Exception Control in Python - EOF</title>
  <meta name="author" content="Jason Leaster">

  
  <meta name="description" content="Pythoner may be familiar with exception control like the demo beblow there: 1
2
3
4
5
6
7
8
9
try: i = 0 while True: i += 1 except KeyboardInterrupt &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jasonleaster.github.io/blog/2016/02/22/exception-control-in-python/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="EOF" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">EOF</a></h1>
  
    <h2>Rebuilding The Tower Of Babel</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="jasonleaster.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/todo">TODO</a></li>
  <li><a href="/recommendation">Recommendation</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Exception Control in Python</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-02-22T11:31:34+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>11:31 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Pythoner may be familiar with exception control like the demo beblow there:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">try</span><span class="p">:</span>
</span><span class="line">    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">
</span><span class="line"><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&quot;after abort:&quot;</span><span class="p">,</span> <span class="n">i</span>
</span><span class="line">
</span><span class="line"><span class="k">print</span> <span class="s">&quot;get here&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<!-- more -->

<p>If you press down <code>ctrl + c</code>, there will trigger a interruption by keyboard. The inner infinite loop will stop and jump into the exception handler. There are another examples of exception and interruption in the computer. Programmer may also ask what’s the benefite to handle the exception …</p>

<p>What if there is something unpredictable and it will stop the program to run correctly?</p>

<p>If you do 1 divide 0 in your program, the CPU don’t know how to compute that expression. In the level of operating system, OS will handle it as an exception and tell programmer that it doesn’t work. The program must be stopped or killed.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">try</span><span class="p">:</span>
</span><span class="line">    <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
</span><span class="line"><span class="k">except</span><span class="p">:</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&quot;Welcome Chapter 42 -- Guideline to galaxy&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Although there trig a exception for diveding zero, but we catch it and handle it correctly. So, the program end correctly.</p>

<p>The mechanism of exception handling come from operating system.</p>

<p>Here is the definition of exception object in Python. (Don’t forget that everything in Python is object).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="p">[</span><span class="n">Include</span><span class="o">/</span><span class="n">pyerrors</span><span class="p">.</span><span class="n">h</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="p">...</span>
</span><span class="line">
</span><span class="line"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="n">PyObject_HEAD</span>
</span><span class="line">    <span class="n">PyObject</span> <span class="o">*</span><span class="n">dict</span><span class="p">;</span>
</span><span class="line">    <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
</span><span class="line">    <span class="n">PyObject</span> <span class="o">*</span><span class="n">message</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span> <span class="n">PyBaseExceptionObject</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="p">...</span>
</span><span class="line">
</span><span class="line"><span class="cm">/* Predefined exceptions */</span>
</span><span class="line">
</span><span class="line"><span class="n">PyAPI_DATA</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">PyExc_BaseException</span><span class="p">;</span>
</span><span class="line"><span class="n">PyAPI_DATA</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">PyExc_Exception</span><span class="p">;</span>
</span><span class="line"><span class="n">PyAPI_DATA</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">PyExc_StopIteration</span><span class="p">;</span>
</span><span class="line"><span class="p">...</span>
</span><span class="line"><span class="n">PyAPI_DATA</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">PyExc_ZeroDivisionError</span><span class="p">;</span>
</span><span class="line"><span class="n">PyAPI_DATA</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">PyExc_EOFError</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here is a example about how python deal with the exception.</p>

<p>What would happen if there is a expression <code>1/0</code>.
I use IPython interpreter do this demo.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&quot;1/0&quot;</span><span class="p">,</span> <span class="s">&quot;testscript&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span> <span class="s">&quot;exec&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="n">dis</span><span class="o">.</span><span class="n">disassemble</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</span><span class="line">      <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">                  <span class="mi">3</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">                  <span class="mi">6</span> <span class="n">BINARY_DIVIDE</span>
</span><span class="line">                  <span class="mi">7</span> <span class="n">POP_TOP</span>
</span><span class="line">                  <span class="mi">8</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class="line">                 <span class="mi">11</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The assemble code (opcode) of expression <code>1/0</code> in Python is compiled into that opcode code. It isn’t difficult to understand what the <code>LOAD_CONST</code> do.</p>

<p>Let’s dig into the detail of <code>BINARY_DIVIDE</code> in Python/ceval.c</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="p">[</span><span class="n">Python</span><span class="o">/</span><span class="n">ceval</span><span class="p">.</span><span class="n">c</span><span class="p">]</span>
</span><span class="line">    <span class="k">for</span><span class="p">(;;)</span><span class="c1">// big for loop</span>
</span><span class="line">        <span class="p">...</span>
</span><span class="line">        <span class="n">TARGET_NOARG</span><span class="p">(</span><span class="n">BINARY_DIVIDE</span><span class="p">)</span>
</span><span class="line">            <span class="p">{</span>
</span><span class="line">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_Py_QnewFlag</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">                    <span class="n">w</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span>
</span><span class="line">                    <span class="n">v</span> <span class="o">=</span> <span class="n">TOP</span><span class="p">();</span>
</span><span class="line">                    <span class="n">x</span> <span class="o">=</span> <span class="n">PyNumber_Divide</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span> <span class="c1">//</span>
</span><span class="line">                    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
</span><span class="line">                    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
</span><span class="line">                    <span class="n">SET_TOP</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class="line">                    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">DISPATCH</span><span class="p">();</span>
</span><span class="line">                    <span class="k">break</span><span class="p">;</span>
</span><span class="line">                <span class="p">}</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">        <span class="p">...</span>
</span><span class="line">
</span><span class="line">        <span class="cm">/* </span>
</span><span class="line"><span class="cm">           set up the basic information for the reason </span>
</span><span class="line"><span class="cm">           why exception happened  -- notes by Jason Leaster</span>
</span><span class="line"><span class="cm">         */</span>
</span><span class="line">        <span class="cm">/* Quickly continue if no error occurred */</span>
</span><span class="line">
</span><span class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">why</span> <span class="o">==</span> <span class="n">WHY_NOT</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">            <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">                <span class="n">READ_TIMESTAMP</span><span class="p">(</span><span class="n">loop1</span><span class="p">);</span>
</span><span class="line">                <span class="k">continue</span><span class="p">;</span> <span class="cm">/* Normal, fast path */</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">            <span class="n">why</span> <span class="o">=</span> <span class="n">WHY_EXCEPTION</span><span class="p">;</span>
</span><span class="line">            <span class="n">x</span> <span class="o">=</span> <span class="n">Py_None</span><span class="p">;</span>
</span><span class="line">            <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">
</span><span class="line">        <span class="p">...</span>
</span><span class="line">
</span><span class="line">        <span class="cm">/* Log traceback info if this is a real exception */</span>
</span><span class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">why</span> <span class="o">==</span> <span class="n">WHY_EXCEPTION</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">            <span class="n">PyTraceBack_Here</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span><span class="line">            <span class="p">...</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="p">...</span>
</span><span class="line">
</span><span class="line"><span class="p">[</span><span class="n">Objects</span><span class="o">/</span><span class="n">abstract</span><span class="p">.</span><span class="n">c</span><span class="p">]</span>
</span><span class="line"><span class="n">BINARY_FUNC</span><span class="p">(</span><span class="n">PyNumber_Subtract</span><span class="p">,</span> <span class="n">nb_subtract</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="cm">/* PyNumber_Divide is just the other name of function nb_divide </span>
</span><span class="line"><span class="cm">   and then you will find that the nb_divide is just a function pointer</span>
</span><span class="line"><span class="cm">   in struct PyNumberMethods.</span>
</span><span class="line">
</span><span class="line"><span class="cm">   The REAL implementation is function @int_classic_div in </span>
</span><span class="line"><span class="cm">   Objects/intobject.c. The @int_classic_div will call function</span>
</span><span class="line"><span class="cm">   @i_divmod in Objects/intobject.c</span>
</span><span class="line">
</span><span class="line"><span class="cm">                                    -- notes by Jason Leaster</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="n">BINARY_FUNC</span><span class="p">(</span><span class="n">PyNumber_Divide</span><span class="p">,</span> <span class="n">nb_divide</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">BINARY_FUNC</span><span class="p">(</span><span class="n">PyNumber_Divmod</span><span class="p">,</span> <span class="n">nb_divmod</span><span class="p">,</span> <span class="s">&quot;divmod()&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="p">[</span><span class="n">Objects</span><span class="o">/</span><span class="n">intobject</span><span class="p">.</span><span class="n">c</span><span class="p">]</span>
</span><span class="line"><span class="n">i_divmod</span><span class="p">(</span><span class="k">register</span> <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="k">register</span> <span class="kt">long</span> <span class="n">y</span><span class="p">,</span>
</span><span class="line">           <span class="kt">long</span> <span class="o">*</span><span class="n">p_xdivy</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p_xmody</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="kt">long</span> <span class="n">xdivy</span><span class="p">,</span> <span class="n">xmody</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="cm">/*</span>
</span><span class="line"><span class="cm">         Keypoint!</span>
</span><span class="line"><span class="cm">         Here is where Python setup a new exception for &quot;divide zero&quot;</span>
</span><span class="line"><span class="cm">         problem.</span>
</span><span class="line"><span class="cm">                                            -- notes by JasonLeaster</span>
</span><span class="line"><span class="cm">         */</span>
</span><span class="line">        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_ZeroDivisionError</span><span class="p">,</span>
</span><span class="line">                <span class="s">&quot;integer division or modulo by zero&quot;</span><span class="p">);</span>
</span><span class="line">        <span class="k">return</span> <span class="n">DIVMOD_ERROR</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="p">...</span> <span class="p">...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It’s the last mile to get the target place.
<code>PyErr_SetString</code> finish the job about the initialization of <code>divide zero</code> exception.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="p">[</span><span class="n">Python</span><span class="o">/</span><span class="n">errors</span><span class="p">.</span><span class="n">c</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="kt">void</span>
</span><span class="line"><span class="n">PyErr_Restore</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">traceback</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PyThreadState</span> <span class="o">*</span><span class="n">tstate</span> <span class="o">=</span> <span class="n">PyThreadState_GET</span><span class="p">();</span>
</span><span class="line">    <span class="n">PyObject</span> <span class="o">*</span><span class="n">oldtype</span><span class="p">,</span> <span class="o">*</span><span class="n">oldvalue</span><span class="p">,</span> <span class="o">*</span><span class="n">oldtraceback</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="p">...</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/* Save these in locals to safeguard against recursive</span>
</span><span class="line"><span class="cm">       invocation through Py_XDECREF */</span>
</span><span class="line">    <span class="n">oldtype</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">curexc_type</span><span class="p">;</span>
</span><span class="line">    <span class="n">oldvalue</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">curexc_value</span><span class="p">;</span>
</span><span class="line">    <span class="n">oldtraceback</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">curexc_traceback</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">curexc_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
</span><span class="line">    <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">curexc_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span><span class="line">    <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">curexc_traceback</span> <span class="o">=</span> <span class="n">traceback</span><span class="p">;</span>
</span><span class="line">    <span class="p">...</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kt">void</span>
</span><span class="line"><span class="n">PyErr_SetObject</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">exception</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="p">...</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/* log this exception message into thread state */</span>
</span><span class="line">    <span class="n">PyErr_Restore</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kt">void</span>
</span><span class="line"><span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">exception</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PyObject</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">PyString_FromString</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
</span><span class="line">    <span class="n">PyErr_SetObject</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class="line">    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>After the VM (ceval.c) know why there is a exception, the VM will take step
into handling this exception. We have knew that the big <code>for switch loop</code> execute the opcode step by step. 
Once there is something wrong with the opcode at runtime, the VM will setup
 exception object by <code>PyErr_SetObject</code>. And then VM also will setup the traceback object of type <code>PyTracebackObject</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="cm">/* Traceback interface */</span>
</span><span class="line">
</span><span class="line"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_traceback</span> <span class="p">{</span>
</span><span class="line">    <span class="n">PyObject_HEAD</span>
</span><span class="line">    <span class="k">struct</span> <span class="n">_traceback</span> <span class="o">*</span><span class="n">tb_next</span><span class="p">;</span>
</span><span class="line">    <span class="k">struct</span> <span class="n">_frame</span> <span class="o">*</span><span class="n">tb_frame</span><span class="p">;</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">tb_lasti</span><span class="p">;</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">tb_lineno</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span> <span class="n">PyTracebackObject</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>You may notice that the <code>PyTracebackObject</code> is a single direction linked-list.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
</pre></td><td class="code"><pre><code class="C"><span class="line"><span class="k">static</span> <span class="n">PyTracebackObject</span> <span class="o">*</span>
</span><span class="line"><span class="nf">newtracebackobject</span><span class="p">(</span><span class="n">PyTracebackObject</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="n">PyFrameObject</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PyTracebackObject</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>
</span><span class="line">    <span class="k">if</span> <span class="p">((</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PyTraceBack_Check</span><span class="p">(</span><span class="n">next</span><span class="p">))</span> <span class="o">||</span>
</span><span class="line">            <span class="n">frame</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">PyFrame_Check</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span> <span class="p">{</span>
</span><span class="line">        <span class="n">PyErr_BadInternalCall</span><span class="p">();</span>
</span><span class="line">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="n">tb</span> <span class="o">=</span> <span class="n">PyObject_GC_New</span><span class="p">(</span><span class="n">PyTracebackObject</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PyTraceBack_Type</span><span class="p">);</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">tb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
</span><span class="line">        <span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class="line">        <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</span><span class="line">        <span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
</span><span class="line">        <span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_lasti</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">f_lasti</span><span class="p">;</span>
</span><span class="line">        <span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_lineno</span> <span class="o">=</span> <span class="n">PyFrame_GetLineNumber</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</span><span class="line">        <span class="n">PyObject_GC_Track</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">tb</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span>
</span><span class="line"><span class="nf">PyTraceBack_Here</span><span class="p">(</span><span class="n">PyFrameObject</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PyThreadState</span> <span class="o">*</span><span class="n">tstate</span> <span class="o">=</span> <span class="n">PyThreadState_GET</span><span class="p">();</span>
</span><span class="line">    <span class="n">PyTracebackObject</span> <span class="o">*</span><span class="n">oldtb</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyTracebackObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">curexc_traceback</span><span class="p">;</span>
</span><span class="line">    <span class="n">PyTracebackObject</span> <span class="o">*</span><span class="n">tb</span> <span class="o">=</span> <span class="n">newtracebackobject</span><span class="p">(</span><span class="n">oldtb</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
</span><span class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">tb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class="line">    <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">curexc_traceback</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">tb</span><span class="p">;</span>
</span><span class="line">    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">oldtb</span><span class="p">);</span>
</span><span class="line">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">h</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&quot;in frame :&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&quot;in function :&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
</span><span class="line">    <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&quot;in frame :&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&quot;in function :&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
</span><span class="line">    <span class="n">h</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&quot;in frame :&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&quot;in function :&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
</span><span class="line">    <span class="n">g</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="n">f</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This program will trig the exception at function h().
Here is the output of that program.</p>

<p><img src="/images/img_for_2016_02_22/traceback.png" alt="images" /></p>

<p><img src="/images/img_for_2016_02_22/frameobjectlist.png" alt="images" /></p>

<h3 id="hacker-time">Hacker Time</h3>

<p><img src="/images/img_for_2016_02_22/hacktime0.png" alt="images" /></p>

<hr />
<p>Photo by Jason Leaster, ChangeDe, HuNan, China
<img src="/images/img_for_2016_02_22/bridge.jpg" alt="images" /></p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jason Leaster</span></span>

      




<time class='entry-date' datetime='2016-02-22T11:31:34+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>11:31 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/python/'>python</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/02/21/architecture-of-python-virtual-machine/" title="Previous Post: Architecture of Python Virtual Machine">&laquo; Architecture of Python Virtual Machine</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/04/09/tuple-and-list-in-python/" title="Next Post: tuple and list in Python">tuple and list in Python &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/04/problems-with-linked-list/">Problems With Linked List</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/24/search-algorithm-in-graph/">Search Algorithm in Graph</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/14/great-ideas-in-object-oriented-programming/">Great Ideas in Object Oriented Programming</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/19/training-cascade-with-opencv/">Training Cascade With OpenCV</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/09/iterater-and-generator-in-python/">Iterater and Generator in Python</a>
      </li>
    
  </ul>
</section>


<section> 
  <h1>Categories</h1> 
  <ul id="categories"> 
    <li class='category'><a href='/blog/categories/algorithm/'>algorithm (4)</a></li>
<li class='category'><a href='/blog/categories/c/'>c (2)</a></li>
<li class='category'><a href='/blog/categories/cplusplus/'>cplusplus (7)</a></li>
<li class='category'><a href='/blog/categories/essay/'>essay (2)</a></li>
<li class='category'><a href='/blog/categories/java/'>java (1)</a></li>
<li class='category'><a href='/blog/categories/labs/'>labs (1)</a></li>
<li class='category'><a href='/blog/categories/machinelearning/'>machinelearning (4)</a></li>
<li class='category'><a href='/blog/categories/opencv/'>opencv (1)</a></li>
<li class='category'><a href='/blog/categories/python/'>python (9)</a></li>
 
  </ul> 
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Jason Leaster -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
