<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Python | EOF]]></title>
  <link href="http://jasonleaster.github.io/blog/categories/python/atom.xml" rel="self"/>
  <link href="http://jasonleaster.github.io/"/>
  <updated>2016-07-01T13:07:56+08:00</updated>
  <id>http://jasonleaster.github.io/</id>
  <author>
    <name><![CDATA[Jason Leaster]]></name>
    <email><![CDATA[jasonleaster@163.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Iterater and Generator in Python]]></title>
    <link href="http://jasonleaster.github.io/blog/2016/04/09/iterater-and-generator-in-python/"/>
    <updated>2016-04-09T13:54:30+08:00</updated>
    <id>http://jasonleaster.github.io/blog/2016/04/09/iterater-and-generator-in-python</id>
    <content type="html"><![CDATA[<p>Try to answer the following question?</p>

<ol>
  <li>
    <p>How do generators save memory?</p>
  </li>
  <li>
    <p>When is the best time to use a generator?</p>
  </li>
  <li>
    <p>How can I use itertools to create complex generator workflows?</p>
  </li>
  <li>
    <p>When is lazy evaluation beneficial, and when is it not?</p>
  </li>
</ol>

<!-- more -->

<p>Programmer who is familiar with another language start learning Python, they are taken aback by the difference in <strong>for</strong> loop notation.</p>

<p>With the influence from others language, they may try to finish iteration job by this code:</p>

<p>``` Python</p>

<p>for i in range(N):
    do_work(i)</p>

<p>```</p>

<p>What the beginner don’t know the implemenation of function range in Python(2.7). The first thing the <strong>range()</strong> function must precreate the list of all numbers within the range.</p>

<p>In Python2.7, range() produce a list but xrange() return a iterator.( In Python 3, the range() is replaced with the xrange() and there is no xrange() function anymore. From this modification, programmer can know that the develop team of Python aware that it’s neccessary to force the user to use a generator when they want to iteration job.)</p>

<p>Here is a test for the differences between the range() and xrange() in memory allocation.</p>

<p><img src="/images/img_for_2016_04_09/range_xrange_time.png" alt="images" />
<img src="/images/img_for_2016_04_09/range_xrange_mem.png" alt="images" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tuple and List in Python]]></title>
    <link href="http://jasonleaster.github.io/blog/2016/04/09/tuple-and-list-in-python/"/>
    <updated>2016-04-09T08:52:51+08:00</updated>
    <id>http://jasonleaster.github.io/blog/2016/04/09/tuple-and-list-in-python</id>
    <content type="html"><![CDATA[<p>Try to answer the following question.</p>

<p>What are lists andd tuples good for?</p>

<p>What is the complexity of a lookup in a list/tuple?</p>

<p>How is that complexity achieved?</p>

<p>What are the differences between lists and tuples?</p>

<p>How does appending to a list work?</p>

<p>When should I use lists and tuples?</p>

<p>Lists and tuples are a class of data structure called arrays. An array is simply a flat list of data with some intrinsic ordering.
This demarcates another line between lists and tuples: <strong>lists are dynamic arrays while tuples are static arrays.</strong></p>

<h3 id="lists-versus-tuples">Lists Versus Tuples</h3>

<p>Differences between lists and tuple</p>

<ol>
  <li>
    <p>lists are dynamic arrays; they are mutable and allow for resizing(changing the number of elements that are held).</p>
  </li>
  <li>
    <p>Tuples are static arrays; they are immutable, and the data within them cannot be changed once they have been created.</p>
  </li>
  <li>
    <p>Tuples are cached by the Python runtime, which means that we don’t need to talk to the kernel to reserve memory every time we want to use one.</p>
  </li>
</ol>

<p>These differences outline the philosophical difference between the two: tuples are for describing multiple properties of one unchanging thing, and list can be used to store collections of data about completely disparate objects.</p>

<p><img src="/images/img_for_2016_04_09/tuple_list_construction_speed.png" alt="images" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Exception Control in Python]]></title>
    <link href="http://jasonleaster.github.io/blog/2016/02/22/exception-control-in-python/"/>
    <updated>2016-02-22T11:31:34+08:00</updated>
    <id>http://jasonleaster.github.io/blog/2016/02/22/exception-control-in-python</id>
    <content type="html"><![CDATA[<p>Pythoner may be familiar with exception control like the demo beblow there:</p>

<p>``` python</p>

<p>try:
    i = 0
    while True:
        i += 1</p>

<p>except KeyboardInterrupt:
    print “after abort:”, i</p>

<p>print “get here”</p>

<p>```</p>

<!-- more -->

<p>If you press down <code>ctrl + c</code>, there will trigger a interruption by keyboard. The inner infinite loop will stop and jump into the exception handler. There are another examples of exception and interruption in the computer. Programmer may also ask what’s the benefite to handle the exception …</p>

<p>What if there is something unpredictable and it will stop the program to run correctly?</p>

<p>If you do 1 divide 0 in your program, the CPU don’t know how to compute that expression. In the level of operating system, OS will handle it as an exception and tell programmer that it doesn’t work. The program must be stopped or killed.</p>

<p>``` python</p>

<p>try:
    1/0
except:
    print “Welcome Chapter 42 – Guideline to galaxy”</p>

<p>```</p>

<p>Although there trig a exception for diveding zero, but we catch it and handle it correctly. So, the program end correctly.</p>

<p>The mechanism of exception handling come from operating system.</p>

<p>Here is the definition of exception object in Python. (Don’t forget that everything in Python is object).</p>

<p>``` C</p>

<p>[Include/pyerrors.h]</p>

<p>…</p>

<p>typedef struct {
    PyObject_HEAD
    PyObject *dict;
    PyObject *args;
    PyObject *message;
} PyBaseExceptionObject;</p>

<p>…</p>

<p>/* Predefined exceptions */</p>

<p>PyAPI_DATA(PyObject *) PyExc_BaseException;
PyAPI_DATA(PyObject *) PyExc_Exception;
PyAPI_DATA(PyObject *) PyExc_StopIteration;
…
PyAPI_DATA(PyObject *) PyExc_ZeroDivisionError;
PyAPI_DATA(PyObject *) PyExc_EOFError;</p>

<p>…</p>

<p>```</p>

<p>Here is a example about how python deal with the exception.</p>

<p>What would happen if there is a expression <code>1/0</code>.
I use IPython interpreter do this demo.</p>

<p>``` python</p>

<p>In [18]: code = compile(“1/0”, “testscript”, mode= “exec”)</p>

<p>In [19]: dis.disassemble(code)
      1           0 LOAD_CONST               0 (1)
                  3 LOAD_CONST               1 (0)
                  6 BINARY_DIVIDE     <br />
                  7 POP_TOP           <br />
                  8 LOAD_CONST               2 (None)
                 11 RETURN_VALUE</p>

<p>```
The assemble code (opcode) of expression <code>1/0</code> in Python is compiled into that opcode code. It isn’t difficult to understand what the <code>LOAD_CONST</code> do.</p>

<p>Let’s dig into the detail of <code>BINARY_DIVIDE</code> in Python/ceval.c</p>

<p>``` C</p>

<p>[Python/ceval.c]
    for(;;)// big for loop
        …
        TARGET_NOARG(BINARY_DIVIDE)
            {
                if (!_Py_QnewFlag) {
                    w = POP();
                    v = TOP();
                    x = PyNumber_Divide(v, w); //
                    Py_DECREF(v);
                    Py_DECREF(w);
                    SET_TOP(x);
                    if (x != NULL) DISPATCH();
                    break;
                }
            }
        …</p>

<pre><code>    /* 
       set up the basic information for the reason 
       why exception happened  -- notes by Jason Leaster
     */
    /* Quickly continue if no error occurred */

    if (why == WHY_NOT) {
        if (err == 0 &amp;&amp; x != NULL) {
            READ_TIMESTAMP(loop1);
            continue; /* Normal, fast path */
        }
        why = WHY_EXCEPTION;
        x = Py_None;
        err = 0;
    }

    ...

    /* Log traceback info if this is a real exception */
    if (why == WHY_EXCEPTION) {
        PyTraceBack_Here(f);
        ...
    }
    ...
</code></pre>

<p>[Objects/abstract.c]
BINARY_FUNC(PyNumber_Subtract, nb_subtract, “-“)</p>

<p>/* PyNumber_Divide is just the other name of function nb_divide 
   and then you will find that the nb_divide is just a function pointer
   in struct PyNumberMethods.</p>

<p>The REAL implementation is function @int_classic_div in 
   Objects/intobject.c. The @int_classic_div will call function
   @i_divmod in Objects/intobject.c</p>

<pre><code>                                -- notes by Jason Leaster  */ BINARY_FUNC(PyNumber_Divide, nb_divide, "/") 
</code></pre>

<p>BINARY_FUNC(PyNumber_Divmod, nb_divmod, “divmod()”)</p>

<p>[Objects/intobject.c]
i_divmod(register long x, register long y,
           long *p_xdivy, long *p_xmody)
{
    long xdivy, xmody;</p>

<pre><code>if (y == 0) {
    /*
     Keypoint!
     Here is where Python setup a new exception for "divide zero"
     problem.
                                        -- notes by JasonLeaster
     */
    PyErr_SetString(PyExc_ZeroDivisionError,
            "integer division or modulo by zero");
    return DIVMOD_ERROR;
}

... ... }
</code></pre>

<p>```</p>

<p>It’s the last mile to get the target place.
<code>PyErr_SetString</code> finish the job about the initialization of <code>divide zero</code> exception.</p>

<p>``` C</p>

<p>[Python/errors.c]</p>

<p>void
PyErr_Restore(PyObject *type, PyObject *value, PyObject *traceback)
{
    PyThreadState *tstate = PyThreadState_GET();
    PyObject *oldtype, *oldvalue, *oldtraceback;</p>

<pre><code>... 

/* Save these in locals to safeguard against recursive
   invocation through Py_XDECREF */
oldtype = tstate-&gt;curexc_type;
oldvalue = tstate-&gt;curexc_value;
oldtraceback = tstate-&gt;curexc_traceback;

tstate-&gt;curexc_type = type;
tstate-&gt;curexc_value = value;
tstate-&gt;curexc_traceback = traceback;
... }
</code></pre>

<p>void
PyErr_SetObject(PyObject *exception, PyObject *value)
{
    …</p>

<pre><code>/* log this exception message into thread state */
PyErr_Restore(exception, value, (PyObject *)NULL); }
</code></pre>

<p>void
PyErr_SetString(PyObject *exception, const char *string)
{
    PyObject *value = PyString_FromString(string);
    PyErr_SetObject(exception, value);
    Py_XDECREF(value);
}</p>

<p>```</p>

<p>After the VM (ceval.c) know why there is a exception, the VM will take step
into handling this exception. We have knew that the big <code>for switch loop</code> execute the opcode step by step. 
Once there is something wrong with the opcode at runtime, the VM will setup
 exception object by <code>PyErr_SetObject</code>. And then VM also will setup the traceback object of type <code>PyTracebackObject</code>.</p>

<p>``` C</p>

<p>/* Traceback interface */</p>

<p>typedef struct _traceback {
    PyObject_HEAD
    struct _traceback *tb_next;
    struct _frame *tb_frame;
    int tb_lasti;
    int tb_lineno;
} PyTracebackObject;</p>

<p>```</p>

<p>You may notice that the <code>PyTracebackObject</code> is a single direction linked-list.</p>

<p>``` C</p>

<p>static PyTracebackObject *
newtracebackobject(PyTracebackObject *next, PyFrameObject *frame)
{
    PyTracebackObject *tb;
    if ((next != NULL &amp;&amp; !PyTraceBack_Check(next)) ||
            frame == NULL || !PyFrame_Check(frame)) {
        PyErr_BadInternalCall();
        return NULL;
    }
    tb = PyObject_GC_New(PyTracebackObject, &amp;PyTraceBack_Type);
    if (tb != NULL) {
        Py_XINCREF(next);
        tb-&gt;tb_next = next;
        Py_XINCREF(frame);
        tb-&gt;tb_frame = frame;
        tb-&gt;tb_lasti = frame-&gt;f_lasti;
        tb-&gt;tb_lineno = PyFrame_GetLineNumber(frame);
        PyObject_GC_Track(tb);
    }
    return tb;
}</p>

<p>int
PyTraceBack_Here(PyFrameObject *frame)
{
    PyThreadState *tstate = PyThreadState_GET();
    PyTracebackObject *oldtb = (PyTracebackObject *) tstate-&gt;curexc_traceback;
    PyTracebackObject *tb = newtracebackobject(oldtb, frame);
    if (tb == NULL)
        return -1;
    tstate-&gt;curexc_traceback = (PyObject *)tb;
    Py_XDECREF(oldtb);
    return 0;
}</p>

<p>```</p>

<p>``` python</p>

<p>import sys</p>

<p>def h():
    print “in frame :”, sys._getframe()
    print “in function :”, sys._getframe().f_code.co_name
    1/0</p>

<p>def g():
    print “in frame :”, sys._getframe()
    print “in function :”, sys._getframe().f_code.co_name
    h()</p>

<p>def f():
    print “in frame :”, sys._getframe()
    print “in function :”, sys._getframe().f_code.co_name
    g()</p>

<p>f()</p>

<p>```</p>

<p>This program will trig the exception at function h().
Here is the output of that program.</p>

<p><img src="/images/img_for_2016_02_22/traceback.png" alt="images" /></p>

<p><img src="/images/img_for_2016_02_22/frameobjectlist.png" alt="images" /></p>

<h3 id="hacker-time">Hacker Time</h3>

<p><img src="/images/img_for_2016_02_22/hacktime0.png" alt="images" /></p>

<hr />
<p>Photo by Jason Leaster, ChangeDe, HuNan, China
<img src="/images/img_for_2016_02_22/bridge.jpg" alt="images" /></p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Architecture of Python Virtual Machine]]></title>
    <link href="http://jasonleaster.github.io/blog/2016/02/21/architecture-of-python-virtual-machine/"/>
    <updated>2016-02-21T11:42:50+08:00</updated>
    <id>http://jasonleaster.github.io/blog/2016/02/21/architecture-of-python-virtual-machine</id>
    <content type="html"><![CDATA[<p>Python virtual machine is the core part of this language. After compiling the original python code into <code>Opcode</code>(byte code), python VM will take the job left. Python will take every opcode from <code>PyCodeObject</code>.</p>

<!-- more -->

<h3 id="executing-environment-in-python-vm">Executing environment in Python VM</h3>

<p>Actually, all the things that VM do is simulating what the OS do to excute a program.</p>

<p><img src="/images/img_for_2016_02_21/stack.png" alt="images" /></p>

<p>The figure over there show the representation of the model of stack-based machine.</p>

<p>If you are fimilary with system programming in C, it’s easy to understand the meaning of that figure.</p>

<p>But if you are an beginner with programming in C, you may try to finish the lab2( bomb ) in CSAPP. It will help beginner a lot to understand the mechanism of stack-based machine.</p>

<p><strong>We know that all the static information about the program store in <code>PyCodeObject</code>. But what about the dynamic information when the program is running in the Python VM?</strong></p>

<p><code>PyCodeObject</code> can’t include the dynamic information and the environment where program is running.</p>

<p>``` python</p>

<p>number = 2016</p>

<p>def f():
    number = 42
    print number # 42</p>

<p>```</p>

<p>You must know <code>number</code> in function <code>f()</code> and the variable which is not inside the block of function <code>f()</code> with the same name. That two variable are in different frame which means envrionment in running time.</p>

<p>In Python, there is a class to describe the envrionment at running time – <code>PyFrameObject</code>. It’s a simulation of stack frame in x86 platform.</p>

<p>You noticed that <code>PyFrameObject</code> is a size-variable Python Object class. Because this class maintain a <code>PyCodeObject</code> and stack in different block have different size. So <code>PyFrameObject</code> can’t be a size fixed class.</p>

<p>``` C</p>

<p>[Inlcude/frameobject.h]</p>

<p>typedef struct _frame {
    PyObject_VAR_HEAD
    struct _frame <em>f_back;  /</em> previous frame, or NULL */</p>

<pre><code>PyCodeObject *f_code;   /* code segment */
PyObject *f_builtins;   /* builtin symbol table (PyDictObject) */
PyObject *f_globals;    /* global symbol table (PyDictObject) */
PyObject *f_locals;     /* local symbol table (any mapping) */
PyObject **f_valuestack;/* points after the last local */

/* Next free slot in f_valuestack.  
Frame creation sets to f_valuestack.
Frame evaluation usually NULLs it, but a frame that yields sets it
to the current stack top. */
PyObject **f_stacktop;

...
</code></pre>

<p>} PyFrameObject;</p>

<p>```</p>

<p>This figure show the origanization of PyFrameObject like a single linked-list. <code>f_back</code> point to the previous frame. <code>f_valuestack</code> is something like <code>ebp</code> register in x86 and <code>f_stacktop</code> like the <code>esp</code> register.</p>

<p><img src="/images/img_for_2016_02_21/frame.png" alt="images" /></p>

<p>How to create a new PyFrameObject? The answer is function <code>PyFrame_New</code>.</p>

<p>``` C</p>

<p>[Object/frameobject.c]</p>

<p>PyFrameObject *
PyFrame_New(PyThreadState <em>tstate, PyCodeObject *code, PyObject *globals,
                    PyObject *locals)
{
    PyFrameObject *back = tstate-&gt;frame;
    PyFrameObject *f; /</em> New frame object */
    PyObject *builtins;
    Py_ssize_t i;</p>

<pre><code>... 
/* Big block of code to set value of @builtins */
...

f-&gt;f_stacktop = f-&gt;f_valuestack;
f-&gt;f_builtins = builtins;
Py_XINCREF(back);
f-&gt;f_back = back;
Py_INCREF(code);
Py_INCREF(globals);
f-&gt;f_globals = globals;

...
/* some details are ommited */
...

f-&gt;f_locals = locals;
f-&gt;f_tstate = tstate;
f-&gt;f_lasti = -1;
f-&gt;f_lineno = code-&gt;co_firstlineno;
f-&gt;f_iblock = 0;

_PyObject_GC_TRACK(f);
return f; }
</code></pre>

<p>```</p>

<p>Luckly, we could access <code>PyFrameObject</code> in Python at running time.</p>

<p>``` python</p>

<p>import sys</p>

<p>value = 3</p>

<p>def g():
    “””
    _getframe([depth]) return a frame object from the call stack.
    If that is deeper than the call stack, ValueError is raised.  The default
    for depth is zero, returning the frame at the top of the call stack.
    “””
    frame = sys._getframe()
    print “current function is : “, frame.f_code.co_name
    caller = frame.f_back
    print “caller function is : “, caller.f_code.co_name
    print “caller’s local namespace : “, caller.f_locals
    print “caller’s global namespace : “, caller.f_globals.keys()</p>

<p>def f():
    a = 1
    b = 2
    g()</p>

<p>def show():
    f()</p>

<p>show()</p>

<p>”””
the output of this program :
jasonleaster@ubuntu:~/Code_by_Jason/Python_language$ python caller.py 
current function is :  g
caller function is :  f
caller’s local namespace :  {‘a’: 1, ‘b’: 2}
caller’s global namespace :  [‘g’, ‘f’, ‘<strong>builtins</strong>’, ‘<strong>file</strong>’, ‘show’, ‘value’, ‘<strong>package</strong>’, ‘sys’, ‘<strong>name</strong>’, ‘<strong>doc</strong>’]
“””</p>

<p>```</p>

<h3 id="name-scope-and-namespace">Name, Scope and Namespace</h3>

<p>We have knew the three different namespace – locals, globals and builtins.
In Python, there is a important basic structure – <code>module</code>.
More generally, every <code>.py</code> file is a module in Python. This concept help Python to divide namespace and reuse the program which have been writed.</p>

<p>Name is helpful to memory something which is not simple enough.</p>

<p>Assignment expression in Python have two things in common:</p>

<ul>
  <li>Create a new object</li>
  <li>build a connection between that new object and a name</li>
</ul>

<p>You may be familary with assignment like this <code>x = 1</code>. But expression like
<code>def function():</code> and <code>class A():</code>, all these expression are also assignment expressions. What assignment to do is that build a connection between the object and name. It’s like a pair (name, object), (x, 1), (code, codeObject) and so on.</p>

<p>A namespace is corresponding with unique scope.</p>

<p>There is a comparasion between Python and C about namespace.</p>

<p><img src="/images/img_for_2016_02_21/compare.png" alt="images" /></p>

<p>Just guess what would happend if you run these two program ?</p>

<p>The right side C program will run correctly but the left side Python program will run into exception for “local variable ‘a’ referenced before assignment”.</p>

<p>The reason is that no matter where the variable are decalred in the scope, all things in that scope can see that variable. But what is interesting is that the assignment expression are after the first print expression. When program run into the first print expression, the assginment are unfinished, 
<strong>which means the local object haven’t created yet.</strong></p>

<p><code>global</code> keyword help programmer to declare a name which is in the global scope.</p>

<p>``` python</p>

<p>def f():
    global a
    print a
    a = 2016
    print a</p>

<p>```
But you should know that once you declare a variable with <code>global</code> keyword, all thing happen to the variable in the local scope will influence that object in the global scope and change it’s value. After function <code>f()</code> finished, the value of a in global scope changed into 2016.</p>

<h3 id="runtime-architecture-of-python-vm">Runtime Architecture of Python VM</h3>

<p>This function is the core part of virtual machine in Python. Once we get the opcode from <code>PyFrameObject</code>, the function <code>PyEval_EvalFrameEx</code> will process that opcode and run it.</p>

<p>``` C</p>

<p>[Python/ceval.c]</p>

<p>…</p>

<p>/* Code access macros */</p>

<h1 id="define-instroffset--intnextinstr---firstinstr">define INSTR_OFFSET()  ((int)(next_instr - first_instr))</h1>
<p>#define NEXTOP()        (*next_instr++)
#define NEXTARG()       (next_instr += 2, (next_instr[-1]«8) + next_instr[-2])
#define PEEKARG()       ((next_instr[2]«8) + next_instr[1])
#define JUMPTO(x)       (next_instr = first_instr + (x))
#define JUMPBY(x)       (next_instr += (x))</p>

<p>…</p>

<p>PyObject *
PyEval_EvalFrameEx(PyFrameObject *f, int throwflag)
{
    …
    for(;;)
    {
            f-&gt;f_lasti = INSTR_OFFSET();// get the opcode
            …
            opcode = NEXTOP();</p>

<pre><code>        oparg = 0;   
        /* allows oparg to be stored in a register because
           it doesn't have to be remembered across a full loop */
        if (HAS_ARG(opcode))
            oparg = NEXTARG(); dispatch_opcode:
                                                                                /* Main switch on opcode */
                                                                                    READ_TIMESTAMP(inst0);
        switch (opcode) {

            case NOP:
                ...
            case LOAD_FAST:
                ...
            case LOAD_CONST:
                ...
                ...
        }


}

... }
</code></pre>

<p>```</p>

<hr />

<p>Photo by QianNan Qu. In XiangTan, HuNan, China.</p>

<p><img src="/images/img_for_2016_02_21/me.jpg" alt="images" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Web Crawler]]></title>
    <link href="http://jasonleaster.github.io/blog/2016/02/19/web-crawler/"/>
    <updated>2016-02-19T21:27:47+08:00</updated>
    <id>http://jasonleaster.github.io/blog/2016/02/19/web-crawler</id>
    <content type="html"><![CDATA[<table>
  <tbody>
    <tr>
      <td>Finished my first web scrawler … =_=</td>
    </tr>
  </tbody>
</table>

<p>Here is all about the spider. It’s small but funny.</p>

<p>After I finish this web scrawler, I learn that. The most important thing to build a web scrawler is not the code but the inverse process. How to build your program like a web browser.</p>

<p>Static web page is easy to get but how about a dynamic web page. Nowadays, more and more website use <code>ajax</code> to meet their bussiness requirement. If you just send a simple request to the server of that web site, you will find than the returned page is just only part of the total user page that you saw in the web browser.</p>

<!-- more -->

<p>Here is my demonstration.
<a href="www.duitang.com">duitang.com</a> is a funny images web site. I love a cute virtual character who is named as Mr.zhangcao . There is a lot of images of that guy. So I want build a web crawler to get that images all.</p>

<p>If you send a request to the <a href="http://www.duitang.com/album/56759353">main page</a> and anlysis the returned page (Python’s library <strong>BeautifulSoup</strong> is helpful to analysis html files), you will find there are some links in the html file. But you will only get about 20+ images but not all images that you viewed in the web browser. When you pull down the button of the brower, you will see more and more images coming out to user.</p>

<p>Why the returned page don’t have all links of images? The answer is <code>ajax</code>(asynchronous JavaScript and XML) is a set of web development techniques using many web technologies on the client-side to create asynchronous Web application.</p>

<p><strong>The monitor in browswer will help programmer who is writing a web spider.</strong></p>

<p>Dig into the detail of http transport, you will find a special request which are sent to server by the client browser.</p>

<p>This is that special url.</p>

<p>``` python</p>

<p>http://www.duitang.com/napi/blog/list/by_album/?album_id=
&amp;limit=24
&amp;include_fields=top_comments%2Cis_root%2Csource_link%2Cbuyable%2Croot_id%2C
status%2Clike_count%2Csender%2Creply_count&amp;start=48&amp;_=1455881387791</p>

<p>```</p>

<p>If client request that url to the server, the server will return a json data object. The job left is to analysis the json object and then get the resource links.</p>

<p>The important part of building a web crawler is not the code but how to find the useful url and get more useful information.</p>

<p>Here is a screenshut for what my web scrawler got.
<img src="/images/img_for_2016_02_19/screenshut.png" alt="images" /></p>

<p>``` python</p>

<p>”””
Programmer 	: EOF
E-mail 		: jasonleaster@163.com
File        : duitang.py
Date        : 2016.02.19</p>

<p>”””
#!/usr/bin/env python
# -<em>- coding: utf-8 -</em>-</p>

<p>import urllib
import urllib2
import json
import re
import time</p>

<p>downloadCount = 0</p>

<p>album_id = 72129639
limit = 100
start = 1</p>

<h1 id="this-function-return-a-url-and-this-url-will-return-a-json-object-data">This function return a URL and this URL will return a json object data.</h1>
<p>def duitangURLMaker(album_id, limit, start):
    url_part_1 = “http://www.duitang.com/napi/blog/list/by_album/?album_id=”
    url_part_2 = “&amp;limit=”
    url_part_3 = “&amp;include_fields=top_comments%2Cis_root%2Csource_link%2Cbuyable%2Croot_id%2Cstatus%2Clike_count%2Csender%2Creply_count&amp;start=”
    url_part_4 = “&amp;_=1455881387791”</p>

<pre><code>URL = url_part_1 + str(album_id) + url_part_2 + str(limit) + url_part_3 + str(start) + url_part_4

return URL
</code></pre>

<p>def imgURLs(jsonDict):
	URLs = []
	object_list = jsonDict[“data”][“object_list”]
	for item in object_list:
		URLs.append(item[“photo”][“path”])</p>

<pre><code>return URLs
</code></pre>

<p>URL 		= duitangURLMaker(album_id, limit, start)
string 		= urllib.urlopen(URL).read()
jsonDict 	= json.loads(string)</p>

<p>URLs = imgURLs(jsonDict)</p>

<p>for url in URLs:
    Filename = “duitang_%s.jpeg” % (downloadCount)
    try:
        urllib.urlretrieve(url, Filename)
        print “Download from”, url
        downloadCount += 1
    except:
        print “Analyse Failed”</p>

<p>```</p>

<h3 id="download-some-pdf-documents-on-a-website">Download some pdf documents on a website</h3>

<p>``` python</p>

<p>”””
Programmer 	:   EOF
E-mail 		:   jasonleaster@163.com
File        :   stanford.py
Date        :   2016.02.19</p>

<p>Description:
	This programmer will help user who is learn cs97 in stanford to download some pdf material in the website.</p>

<p>”””
import urllib
from BeautifulSoup import *
import urllib2
import json
import re
import time</p>

<p>URL = “http://web.stanford.edu/class/cs97si/”
html = urllib.urlopen(URL).read()
soup = BeautifulSoup(html)
tags = soup(‘a’)</p>

<p>downloadCount = 0</p>

<p>pattern = “.pdf$”
regex = re.compile(pattern)
for tag in tags:
    fileName = tag[“href”]
    url = URL + fileName</p>

<pre><code>"""
search(string[, pos[, endpos]]) --&gt; match object or None.
Scan through string looking for a match, and return a corresponding
MatchObject instance. Return None if no position in the string matches.
"""
url = regex.search(url)
regex.search
if url is not None:
    url = url.string
    try:
        urllib.urlretrieve(url, fileName)
        print "Download from", url
        downloadCount += 1
    except:
        print "Analyse Failed"
</code></pre>

<p>```</p>

<hr />
<p>Photo by Jason Leaster. LiuYe Lake in ChangDe, HuNan, China.
<img src="/images/img_for_2016_02_19/liuyehu.jpg" alt="images" /></p>
]]></content>
  </entry>
  
</feed>
